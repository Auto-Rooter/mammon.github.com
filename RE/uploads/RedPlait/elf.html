<html>
<head>
<!-- 
     How to make small Linux programs
     Version 0.1
     Written by Red Plait
     08 APR 2000
 -->
 <META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1251">
 <title>Как сделать Linux программы меньше</title>
</head>
<body color=white>
<h2>Как сделать Linux программы меньше</h2>
<table width=100% border=0>
 <tr>
  <td width=60%>&nbsp;</td>
  <td align=left>
<i>
I'm ahead, I'm the man<br>
I'm the first mammal to wear pants, yeah<br>
I'm at peace with my lust<br>
I can kill 'cause in God I trust, yeah<br><br>
It's evolution, baby</i><br>
<p align=right>Pearl Jam, &quot;Do the Evolution&quot;</p><br>
  </td>
 </tr>
</table>
<i>
Данный опус описывает два способа уменьшения размера ELF программ под Линух, однако
 эти способы не специфичны для Линукса, и работают также под FreeBSD (возможно,
 они будут работать и под некоторыми другими Unixes на платформе Intel x86).
</i>
<h3>Предисловие</h3>
В наши дни почти никто не задумывается о размере программ. И это очень печальное
 последствие монополии Микрософт - вместо того, чтобы думать об эффективном
 использовании имеющегося оборудования, эти парни пишут всё более прожорливые
 (но вовсе не всё более лучшие) монстрообразные программы, вынуждая конечных
 пользователей каждый год покупать всё более новые компьютеры (более мощные и дорогие).
 Меня уже давно тошнит писать программы под &quot;операционные системы&quot; этой
 фирмы - да и глупо заниматься оптимизацией программ для платформы, которая 
 предназначена исключительно для того, чтобы заставить пользователя купить
 более мощную машину. Так что мы будем рассматривать альтернативные платформы - 
 Linux &amp; FreeBSD. Поэтому Вы должны иметь машину с установленным на ней 
 одним из этих дистрибутивов. На этом требования и заканчиваются.
<h3>Nasm improvements</h3>
В самом деле, один из самых простых способов уменьшить размеры программы - писать
 её на ассемблере. Я лично считаю одним из лучших ассемблеров под Unixes на
 платформе x86 <b>Nasm</b>, взять можно на <a href="http://www.cryogen.com/Nasm/">http://www.cryogen.com/Nasm/</a>.
 Однако при создании ELF-файлов (самый распространённый формат исполнимых файлов
 под Unix) он вставляет в каждый объектный файл секцию с комментариями, что
 данный файл был произведён Nasmом версии такой-то. Но ведь я и так знаю это !
 Зачем мне нужна в каждом объектном файле такая секция ? Кроме того, содержимое 
 всех этих секции аккумулируется при линковке в секции комментариев исполнимого
 файла ! В общем, я &quot;доработал&quot; файл <b>outelf.c</b> из версии 0.98 
 (последняя на сегодняшний момент), отвечающий за генерацию объектных
 файлов в ELF формате, так что теперь туда не помещается секция с комментариями.
 Я надеюсь, парни из команды разработчиков Nasmа на меня не сильно за это 
 обидятся - мы и так знаем, что их продукт лучший, а теперь он стал даже ещё
 лучше - он генерирует файлы меньшего размера ! Но если Вам всё-таки нравится
 иметь строку с copyrights, вы можете закомментировать строчку
<pre>
#define RP_NO_COMMENT
</pre>
 и всё будет как раньше.<br>
 Установка патча очень проста - переписываете исходный файл моим и перекомпилируете
 - всё...<br>
 Платформы: любой Unix на платформе Intel x86 процессоров (естественно, если Вы 
 сможете собрать на нём сам Nasm). Проверялось на Nasm 0.98 на
<ul>
 <li>FreeBSD 3.1 &amp; 3.4</li>
 <li>Red Hat Linux 5.1 &amp; 6.1</li>
 <li>Caldera OpenLinux 2.2</li>
 <li>UnixWare 7.1</li>
 <li>SCO OpenServer 5.0.5</li>
</ul>
 PS: можете считать это моим началом работы над проектом модификации Nasmа (см. раздел Projects)
<h3>ELF compact</h3>
Хм, а как быть с уже скомпилированными исполнимыми файлами ? Действительно ли
 ELF файлы не содержат ничего лишнего ? На изучение этого вопроса я потратил
 около двух недель (в основном просматривая исходный код загрузчика ELF файлов
 на исполнение в Linux кернеле и ELF interpretorа). И в результате выяснились очень 
 интересные вещи. ELF формат имеет два типа секций - одни обычные, используемые
 линковщиком и иже с ним, а другие - так называемые программные, т.е. которые
 используются кернелом при загрузке файла на исполнение. Более того, если, скажем,
 для объектных файлов и разделяемых библиотек необходимы первые (символьные) - по 
 достаточно очевидным причинам, ведь эти файлы предназначены для их дальнейшей
 обработки (линковка или динамическая загрузка), то для обычных исполнимых
 файлов необходимы ТОЛЬКО программные секции. Ни код запуска ELFов, ни ELF interpretor
 в своей работе не используют символьных секций ! Тем не менее, линковщик честно
 помещает их в каждый генерируемый файл. Это цель для приложения усилий номер раз.<br>
 Я написал сначала программку <b>elf_dump</b>, которая просто распечатывает ELF заголовок и 
 заголовки секций обоих типов (я так и не смог заставить <b>objdump</b> показывать
 все секции файла, включая программные секции). И выяснились ещё более забавные вещи - 
 оказывается уже упомянутая секция с комментариями, а также секции с символьной
 таблицей (та, что удаляется, когда Вы делаете <b>strip</b>) вообще не грузятся
 кернелом для исполнения. Т.е. программа может легко обойтись без них. Это наша цель
 номер два.<br>
Для проверки концепции за два часа на свет появилась другая программа - <b>elf_compact</b>.
 Назначение её очень просто - она открывает файл, проверяет, что открытый файл - ELF,
 что он исполнимый и отрезает у него всё лишнее, переписывая всё нужное в файл
 с таким же именем, что и основной, с суффиксом &quot;.cmpt&quot;. И она работает !
 Более того, она работает не только на Linux, но и с программами от FreeBSD (на что я,
 честно говоря, даже не рассчитывал).Я даже собрал обе программы под Win32 с помощью
 Visual C++ 6.0 - получилось что-то вроде cross-optimizatorа. Она может также
 служить заменой <b>strip</b>. И при всех её достоинствах исходный код имеет
 размеры всего 5 Kb ! По всем законам жанра такая хакерская утилита просто 
 обязана быть написана в машинных кодах, в крайнем случае на ассемблере, но, 
 поскольку я очень ленив, придётся Вам довольствоваться переносимым C
<h4>Неочевидные следствия</h4>
Оказалось, что, несмотря на то, что выходные файлы отлично запускаются и работают,
 и вообще кернел не испытывает каких-либо неудобств от ампутации мусора, ни отладчик
 <b>gdb</b>, ни утилиты из <b>binutils</b> не могут жить без символьных секций
 и отказываются иметь с такими файлами дело. Т.е. совершенно непроизвольно на
 свет появился также простейший ELF protector (насколько я знаю, первый в своём роде -
 по крайней мере ни я, ни те люди, которым я дал эту программу для тестирования,
 ничего аналогичного под Linux не знают). Это тем более иронично, что до этого я в основном
 ломал программы под Linux/Unix ! Краткий перечень сломанного прилагается (IMHO,
 далеко не полный - что-то с памятью в последнее время стало совсем плохо - весна,
 однако...):
<ul>
 <li>SCO OpenServer 5.0.x (практически все версии - 5.0.2, 5.0.4, 5.0.5) - сломал
 всё, что было на их инсталляционных дисках</li>
 <li>UnixWare 7.0 &amp; 7.1 - отломано ограничение на максимальное количество сетевых
 подключений</li>
 <li>Oracle 8.0.5 for UnixWare - на предмет максимального числа подключений</li>
 <li>StarOffice 5.0 for Linux - ещё когда StarDivision не купила Sun. Инсталлировался
 на любой серийный номер</li>
 <li>InterBase 5.6 for Linux - написан генератор лицензий</li>
 <li>YardSQL for FreeBSD - написан генератор файлов лицензий</li>
 <li>SOLID for FreeBSD &amp; for Linux - отломлена проверка на окончание trial-периода
 и на максимальный размер базы и число подключений</li>
 <li>Yandex Lite - аж целых три версии for Linix и одну for FreeBSD - устранение всех
 ограничений демо-версии</li>
 <li>C-Forge for Linux (кстати, хорошая среда разработки) - снятие trialа</li>
 <li>VmWare 1.0 for Linux - как давно это было...</li>
 <li>Jaguar v3.4 &amp; v4.0 for Linux - прога для химических расчётов</li>
 <li>Chili!Soft ASP for Linux</li>
</ul>
 И вот на старости лет угораздило написать защиту. Впрочем, я не совсем болен
 на голову, и уже на следующий день нашёл способ, как загружать такие &quot;оптимизированные&quot;
 исполнимые файлы в IDA Pro - я написал для них свой loader. Он грузит такие
 файлы правильно - т.е. не так как описано в спецификации ELF формата, а так,
 как это делает Linux кернел.
 Но ! когда я обратился к Гильфанову на предмет получить исходные коды его
 загрузчика ELFов, в ответ мне было сказано, что 
 &quot;папуасам и хакерам никогда я исходные коды не дам, даже не проси !&quot;
 Так что
<ol>
 <li>Я обиделся на Гильфанова</li>
 <li>Loader вряд ли обладает всей функциональностью оригинального ELF loaderа,
 в частности, понимает ТОЛЬКО x86 файлы. Впрочем, у меня и нет другого оборудования
  </li>
 <li>Поскольку я затратил слишком много времени, нервов и ресурсов на выяснение сначала
 как это всё работает, на бесплодную переписку с Ильфаком и Eric Youngdale (автор 
 кода загрузки ELFов в Linux кернеле, и по совместительству автор ELF interpretorа),
 а затем ещё и на reverse engeneering творений Ильфака, мой loader
 не будет выложен как OpenSource, как все прочие инструменты. Если он Вам нужен - обратитесь
 к Ильфаку. Или ко мне - у меня будет дешевле (ведь мне не нужно поддерживать 
 бельгийский уровень жизни, как мне Ильфак однажды сказал :-)
  </li>
</ol>
 Я же планирую написать несколько более усложнённый вариант настоящей защиты
 под Linux (кто же лучше крякера сможет это сделать ?), возможно с применением
 модулей в кернеле и есть ещё пара идей (пока не скажу) - в общем, что-то вроде
 VBoxа под Linux...
<h3>Ссылки</h3>
<ul>
 <li><a href="http://www.cryogen.com/Nasm/">Netwide Assembler home page</a></li>
 <li><a href="http://www.linuxassembly.org/resources.html">Linux Assembly Project</a> 
 - проект нашего соотечественника Константина Болдышева по написанию различный Linux-утилит на ассемблере.
 Содержит множество полезной информации и ссылок
  </li>
 <li><a href="http://www.muppetlabs.com/~breadbox/software/ELF.txt">Описание ELF формата</a></li>
 <li><a href="http://www.muppetlabs.com/~breadbox/software/tiny/teensy.html">Как сделать
 Ваши Linux-пргограммы ещё меньше :-)</a>
  </li>
 <li><a href="http://asmjournal.freeservers.com/">Assembly Programming Journal</a></li>
</ul>

<p align=left><a name="disclaim"></a>
<h3>Жалобы и предложения</h3>
 можно отправлять автору по адресу <a href="mailto:redplait@usa.net">redplait@usa.net</a>.
 На глупые вопросы типа &quot;Что такое FreeBSD ?&quot; или 
 &quot;где мне взять что-либо из описанного в этой статье ?&quot; я не отвечаю.
 Если же Вы нашли bug, имеете конструктивные идеи или уверены в
 моей неправоте - всегда открыт к общению. Также большая просьба - не присылайте
 мне десятимегабайтных (притом несжатых) файлов в качестве доказательства чего бы
 то ни было.<br>
 Ну и если Вы хотите защитить свои программы под Linux/FreeBSD (или наоборот, сломать
 чужие :-) - теперь Вы знаете, к кому обратиться...
<br>
 Кроме того, автор не несёт ответственности за последствия работы его программ...
<pre>
#include &lt;std_disclaim.h&gt;
</pre>
</body>
</html>